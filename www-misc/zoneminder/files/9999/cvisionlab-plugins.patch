diff -aurN zoneminder/trunk/configure zoneminder_new/trunk/configure
--- zoneminder/trunk/configure	2011-04-01 17:08:37.000000000 +0200
+++ zoneminder_new/trunk/configure	2011-04-01 21:14:15.000000000 +0200
@@ -2999,6 +2999,7 @@
 
 
 
+LDFLAGS="$LDFLAGS -rdynamic "
 LDFLAGS="${MYSQL_LIBS} $LDFLAGS"
 
 FFMPEG_PREFIX=/usr
@@ -9324,7 +9325,7 @@
 
 
 
-ac_config_files="$ac_config_files Makefile zm.conf zmconfgen.pl db/Makefile db/zm_create.sql scripts/Makefile scripts/zm scripts/zmaudit.pl scripts/zmcontrol.pl scripts/zmdc.pl scripts/zmfilter.pl scripts/zmpkg.pl scripts/zmtrack.pl scripts/zmtrigger.pl scripts/zmupdate.pl scripts/zmvideo.pl scripts/zmwatch.pl scripts/zmx10.pl scripts/zmdbbackup scripts/zmdbrestore scripts/zmeventdump scripts/zmlogrotate.conf scripts/ZoneMinder/lib/ZoneMinder/Base.pm scripts/ZoneMinder/lib/ZoneMinder/Config.pm scripts/ZoneMinder/lib/ZoneMinder/Memory.pm scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm src/Makefile src/zm_config.h web/Makefile web/ajax/Makefile web/css/Makefile web/graphics/Makefile web/includes/Makefile web/includes/config.php web/js/Makefile web/lang/Makefile web/skins/Makefile web/skins/classic/Makefile web/skins/classic/ajax/Makefile web/skins/classic/css/Makefile web/skins/classic/graphics/Makefile web/skins/classic/includes/Makefile web/skins/classic/js/Makefile web/skins/classic/lang/Makefile web/skins/classic/views/Makefile web/skins/classic/views/css/Makefile web/skins/classic/views/js/Makefile web/skins/mobile/Makefile web/skins/mobile/ajax/Makefile web/skins/mobile/css/Makefile web/skins/mobile/graphics/Makefile web/skins/mobile/includes/Makefile web/skins/mobile/lang/Makefile web/skins/mobile/views/Makefile web/skins/mobile/views/css/Makefile web/tools/Makefile web/tools/mootools/Makefile web/views/Makefile web/skins/xml/Makefile web/skins/xml/views/Makefile web/skins/xml/includes/Makefile web/zmApache.conf"
+ac_config_files="$ac_config_files Makefile zm.conf db/Makefile db/zm_create.sql scripts/Makefile scripts/zm scripts/zmaudit.pl scripts/zmcontrol.pl scripts/zmdc.pl scripts/zmfilter.pl scripts/zmpkg.pl scripts/zmtrack.pl scripts/zmtrigger.pl scripts/zmupdate.pl scripts/zmvideo.pl scripts/zmwatch.pl scripts/zmx10.pl scripts/zmdbbackup scripts/zmdbrestore scripts/zmeventdump scripts/zmlogrotate.conf scripts/ZoneMinder/lib/ZoneMinder/Base.pm scripts/ZoneMinder/lib/ZoneMinder/Config.pm scripts/ZoneMinder/lib/ZoneMinder/Memory.pm scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm src/Makefile src/zm_config.h web/Makefile web/ajax/Makefile web/css/Makefile web/graphics/Makefile web/includes/Makefile web/includes/config.php web/js/Makefile web/lang/Makefile web/skins/Makefile web/skins/classic/Makefile web/skins/classic/ajax/Makefile web/skins/classic/css/Makefile web/skins/classic/graphics/Makefile web/skins/classic/includes/Makefile web/skins/classic/js/Makefile web/skins/classic/lang/Makefile web/skins/classic/views/Makefile web/skins/classic/views/css/Makefile web/skins/classic/views/js/Makefile web/skins/mobile/Makefile web/skins/mobile/ajax/Makefile web/skins/mobile/css/Makefile web/skins/mobile/graphics/Makefile web/skins/mobile/includes/Makefile web/skins/mobile/lang/Makefile web/skins/mobile/views/Makefile web/skins/mobile/views/css/Makefile web/tools/Makefile web/tools/mootools/Makefile web/views/Makefile web/skins/xml/Makefile web/skins/xml/views/Makefile web/skins/xml/includes/Makefile web/zmApache.conf"
 
 
 # Create the definitions for compilation and defaults for the database
@@ -10054,7 +10055,6 @@
     "depfiles") CONFIG_COMMANDS="$CONFIG_COMMANDS depfiles" ;;
     "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
     "zm.conf") CONFIG_FILES="$CONFIG_FILES zm.conf" ;;
-    "zmconfgen.pl") CONFIG_FILES="$CONFIG_FILES zmconfgen.pl" ;;
     "db/Makefile") CONFIG_FILES="$CONFIG_FILES db/Makefile" ;;
     "db/zm_create.sql") CONFIG_FILES="$CONFIG_FILES db/zm_create.sql" ;;
     "scripts/Makefile") CONFIG_FILES="$CONFIG_FILES scripts/Makefile" ;;
@@ -10795,7 +10795,6 @@
   done
 }
  ;;
-    "src/zm_config_defines.h":C) perl ./zmconfgen.pl ;;
     "scripts/ZoneMinder/Makefile":C) (cd scripts/ZoneMinder; echo "perl Makefile.PL $PERL_MM_PARMS"; perl Makefile.PL $PERL_MM_PARMS) ;;
 
   esac
diff -aurN zoneminder/trunk/configure.ac zoneminder_new/trunk/configure.ac
--- zoneminder/trunk/configure.ac	2011-04-01 17:08:37.000000000 +0200
+++ zoneminder_new/trunk/configure.ac	2011-04-01 21:14:33.000000000 +0200
@@ -372,10 +372,8 @@
 AC_SUBST(PERL_MM_PARMS)
 AC_SUBST(EXTRA_PERL_LIB)
 
-AC_CONFIG_FILES([Makefile zm.conf zmconfgen.pl db/Makefile db/zm_create.sql scripts/Makefile scripts/zm scripts/zmaudit.pl scripts/zmcontrol.pl scripts/zmdc.pl scripts/zmfilter.pl scripts/zmpkg.pl scripts/zmtrack.pl scripts/zmtrigger.pl scripts/zmupdate.pl scripts/zmvideo.pl scripts/zmwatch.pl scripts/zmx10.pl scripts/zmdbbackup scripts/zmdbrestore scripts/zmeventdump scripts/zmlogrotate.conf scripts/ZoneMinder/lib/ZoneMinder/Base.pm scripts/ZoneMinder/lib/ZoneMinder/Config.pm scripts/ZoneMinder/lib/ZoneMinder/Memory.pm scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm src/Makefile src/zm_config.h web/Makefile web/ajax/Makefile web/css/Makefile web/graphics/Makefile web/includes/Makefile web/includes/config.php web/js/Makefile web/lang/Makefile web/skins/Makefile web/skins/classic/Makefile web/skins/classic/ajax/Makefile web/skins/classic/css/Makefile web/skins/classic/graphics/Makefile web/skins/classic/includes/Makefile web/skins/classic/js/Makefile web/skins/classic/lang/Makefile web/skins/classic/views/Makefile web/skins/classic/views/css/Makefile web/skins/classic/views/js/Makefile web/skins/mobile/Makefile web/skins/mobile/ajax/Makefile web/skins/mobile/css/Makefile web/skins/mobile/graphics/Makefile web/skins/mobile/includes/Makefile web/skins/mobile/lang/Makefile web/skins/mobile/views/Makefile web/skins/mobile/views/css/Makefile web/tools/Makefile web/tools/mootools/Makefile web/views/Makefile web/skins/xml/Makefile web/skins/xml/views/Makefile web/skins/xml/includes/Makefile web/zmApache.conf])
+AC_CONFIG_FILES([Makefile zm.conf db/Makefile db/zm_create.sql scripts/Makefile scripts/zm scripts/zmaudit.pl scripts/zmcontrol.pl scripts/zmdc.pl scripts/zmfilter.pl scripts/zmpkg.pl scripts/zmtrack.pl scripts/zmtrigger.pl scripts/zmupdate.pl scripts/zmvideo.pl scripts/zmwatch.pl scripts/zmx10.pl scripts/zmdbbackup scripts/zmdbrestore scripts/zmeventdump scripts/zmlogrotate.conf scripts/ZoneMinder/lib/ZoneMinder/Base.pm scripts/ZoneMinder/lib/ZoneMinder/Config.pm scripts/ZoneMinder/lib/ZoneMinder/Memory.pm scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm src/Makefile src/zm_config.h web/Makefile web/ajax/Makefile web/css/Makefile web/graphics/Makefile web/includes/Makefile web/includes/config.php web/js/Makefile web/lang/Makefile web/skins/Makefile web/skins/classic/Makefile web/skins/classic/ajax/Makefile web/skins/classic/css/Makefile web/skins/classic/graphics/Makefile web/skins/classic/includes/Makefile web/skins/classic/js/Makefile web/skins/classic/lang/Makefile web/skins/classic/views/Makefile web/skins/classic/views/css/Makefile web/skins/classic/views/js/Makefile web/skins/mobile/Makefile web/skins/mobile/ajax/Makefile web/skins/mobile/css/Makefile web/skins/mobile/graphics/Makefile web/skins/mobile/includes/Makefile web/skins/mobile/lang/Makefile web/skins/mobile/views/Makefile web/skins/mobile/views/css/Makefile web/tools/Makefile web/tools/mootools/Makefile web/views/Makefile web/skins/xml/Makefile web/skins/xml/views/Makefile web/skins/xml/includes/Makefile web/zmApache.conf])
 
-# Create the definitions for compilation and defaults for the database
-AC_CONFIG_COMMANDS([src/zm_config_defines.h],[perl ./zmconfgen.pl])
 # Manually generate the perl Makefile maker
 AC_CONFIG_COMMANDS([scripts/ZoneMinder/Makefile],[(cd scripts/ZoneMinder; echo "perl Makefile.PL $PERL_MM_PARMS"; perl Makefile.PL $PERL_MM_PARMS)],[PERL_MM_PARMS=$PERL_MM_PARMS])
 
diff -aurN zoneminder/trunk/db/Makefile.am zoneminder_new/trunk/db/Makefile.am
--- zoneminder/trunk/db/Makefile.am	2011-04-01 17:08:29.000000000 +0200
+++ zoneminder_new/trunk/db/Makefile.am	2011-04-01 20:01:20.000000000 +0200
@@ -39,4 +39,5 @@
 	zm_update-1.23.3.sql \
 	zm_update-1.24.0.sql \
 	zm_update-1.24.1.sql \
-	zm_update-1.24.2.sql
+	zm_update-1.24.2.sql \
+	zm_update-plugins.sql
diff -aurN zoneminder/trunk/db/Makefile.in zoneminder_new/trunk/db/Makefile.in
--- zoneminder/trunk/db/Makefile.in	2011-04-01 17:08:29.000000000 +0200
+++ zoneminder_new/trunk/db/Makefile.in	2011-04-01 20:01:20.000000000 +0200
@@ -221,7 +221,8 @@
 	zm_update-1.23.3.sql \
 	zm_update-1.24.0.sql \
 	zm_update-1.24.1.sql \
-	zm_update-1.24.2.sql
+	zm_update-1.24.2.sql \
+	zm_update-plugins.sql
 
 all: all-am
 
diff -aurN zoneminder/trunk/db/zm_create.sql.in zoneminder_new/trunk/db/zm_create.sql.in
--- zoneminder/trunk/db/zm_create.sql.in	2011-04-01 17:08:29.000000000 +0200
+++ zoneminder_new/trunk/db/zm_create.sql.in	2011-04-01 20:01:20.000000000 +0200
@@ -351,6 +351,8 @@
   `SignalCheckColour` varchar(32) NOT NULL default '#0000BE',
   `WebColour` varchar(32) NOT NULL default 'red',
   `Sequence` smallint(5) unsigned default NULL,
+  `UsedPl` varchar(88) NOT NULL default '',
+  `DoNativeMotDet` varchar(5) NOT NULL default 'yes',
   PRIMARY KEY  (`Id`)
 ) ENGINE=@ZM_MYSQL_ENGINE@;
 
@@ -596,6 +598,13 @@
 INSERT INTO ZonePresets VALUES (5,'Best, medium sensitivity','Active','Percent','Blobs',40,NULL,16,NULL,5,5,12,NULL,10,NULL,1,NULL,0);
 INSERT INTO ZonePresets VALUES (6,'Best, high sensitivity','Active','Percent','Blobs',20,NULL,8,NULL,3,3,6,NULL,5,NULL,1,NULL,0);
 
+insert into Config set Id=197, Name = 'ZM_PATH_PLUGINS', Value = '/usr/share/zoneminder', Type = 'string', DefaultValue = '/usr/share/zoneminder', Hint = '/absolute/path/to/somewhere', Pattern = '(?-xism:^((?:/[^/]*)+?)/?$)', Format = ' $1 ', Prompt = 'Path to the plugin folder', Help = '3d-party plugins have to be placed here.', Category = 'paths', Readonly = '0', Requires = '';
+insert into Config set Id=198, Name = 'ZM_PLUGIN_EXTENSION', Value = '.zmpl', Type = 'string', DefaultValue = '.zmpl', Hint = '.bla', Pattern = '.(?-xism:^((?:/[^/]*)+?)/?$)', Format = ' $1 ', Prompt = 'Default extension of plugins to found', Help = '3d-party plugins extension.', Category = 'paths', Readonly = '0', Requires = '';
+insert into Config set Id=199, Name = 'ZM_PLUGINS_CONFIG_FILE', Value = '/usr/share/zoneminder/plugins.conf', Type = 'string', DefaultValue = '/usr/share/zoneminder/plugins.conf', Hint = '/absolute/path/to/somewhere', Pattern = '(?-xism:^((?:/[^/]*)+?)/?$)', Format = ' $1 ', Prompt = 'Path to the config file for plugins', Help = 'Path to the config file for plugins.', Category = 'paths', Readonly = '0', Requires = '';
+insert into Config set Id=200, Name = 'ZM_LOAD_PLUGINS', Value = '0', Type = 'boolean', DefaultValue = 'no', Hint = 'yes|no', Pattern = '(?i-xsm:^([yn]))', Format = ' $1 =~ /^y/) ? \"yes\" : \"no\" ', Prompt = 'Load and use 3d-party plugins', Help = '3d-party plugins will be loaded and used for analysing.', Category = 'config', Readonly = '0', Requires = '';
+insert into Config set Id=201, Name = 'ZM_TURNOFF_NATIVE_ANALYSIS', Value = '0', Type = 'boolean', DefaultValue = 'no', Hint = 'yes|no', Pattern = '(?i-xsm:^([yn]))', Format = ' $1 =~ /^y/) ? \"yes\" : \"no\" ', Prompt = 'Turn native ZM\'s image analysis possibility off', Help = 'Image analysis with ZM\'s motion detected function will be turned off. Only detection functions from loaded plugins will be used. Note, that if no plugins have be loaded, no detection will be done', Category = 'config', Readonly = '0', Requires = '';
+
+
 --
 -- Apply the initial configuration
 --
diff -aurN zoneminder/trunk/db/zm_update-plugins.sql zoneminder_new/trunk/db/zm_update-plugins.sql
--- zoneminder/trunk/db/zm_update-plugins.sql	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/db/zm_update-plugins.sql	2011-04-01 21:13:32.000000000 +0200
@@ -0,0 +1,26 @@
+--
+-- This is update from 1.24.2 version to plugins supporting architecture.
+--
+
+-- Add two columns to store plugins related information.
+ALTER TABLE Monitors
+ADD ( `UsedPl` varchar(88) NOT NULL default '',
+      `DoNativeMotDet` varchar(5) NOT NULL default 'yes'
+);
+
+-- Insert some values into `Config' table.
+INSERT INTO Config SET Id = 197, Name = 'ZM_PATH_PLUGINS', Value = '/usr/share/zoneminder', Type = 'string', DefaultValue = '/usr/share/zoneminder', Hint = '/absolute/path/to/somewhere', Pattern = '(?-xism:^((?:/[^/]*)+?)/?$)', Format = ' $1 ', Prompt = 'Path to the plugin folder', Help = '3d-party plugins have to be placed here.', Category = 'paths', Readonly = '0', Requires = '';
+INSERT INTO Config SET Id = 198, Name = 'ZM_PLUGIN_EXTENSION', Value = '.zmpl', Type = 'string', DefaultValue = '.zmpl', Hint = '.bla', Pattern = '.(?-xism:^((?:/[^/]*)+?)/?$)', Format = ' $1 ', Prompt = 'Default extension of plugins to found', Help = '3d-party plugins extension.', Category = 'paths', Readonly = '0', Requires = '';
+INSERT INTO Config SET Id = 199, Name = 'ZM_PLUGINS_CONFIG_FILE', Value = '/usr/share/zoneminder/plugins.conf', Type = 'string', DefaultValue = '/usr/share/zoneminder/plugins.conf', Hint = '/absolute/path/to/somewhere', Pattern = '(?-xism:^((?:/[^/]*)+?)/?$)', Format = ' $1 ', Prompt = 'Path to the config file for plugins', Help = 'Path to the config file for plugins.', Category = 'paths', Readonly = '0', Requires = '';
+INSERT INTO Config SET Id = 200, Name = 'ZM_LOAD_PLUGINS', Value = '0', Type = 'boolean', DefaultValue = 'no', Hint = 'yes|no', Pattern = '(?i-xsm:^([yn]))', Format = ' $1 =~ /^y/) ? \"yes\" : \"no\" ', Prompt = 'Load and use 3d-party plugins', Help = '3d-party plugins will be loaded and used for analysing.', Category = 'config', Readonly = '0', Requires = '';
+INSERT INTO Config SET Id = 201, Name = 'ZM_TURNOFF_NATIVE_ANALYSIS', Value = '0', Type = 'boolean', DefaultValue = 'no', Hint = 'yes|no', Pattern = '(?i-xsm:^([yn]))', Format = ' $1 =~ /^y/) ? \"yes\" : \"no\" ', Prompt = 'Turn native ZM\'s image analysis possibility off', Help = 'Image analysis with ZM\'s motion detected function will be turned off. Only detection functions from loaded plugins will be used. Note, that if no plugins have be loaded, no detection will be done', Category = 'config', Readonly = '0', Requires = '';
+
+--
+-- These are optional, but we might as well
+--
+optimize table Frames;
+optimize table Events;
+optimize table Filters;
+optimize table Zones;
+optimize table Monitors;
+optimize table Stats;
diff -aurN zoneminder/trunk/scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm.in zoneminder_new/trunk/scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm.in
--- zoneminder/trunk/scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm.in	2011-04-01 17:08:31.000000000 +0200
+++ zoneminder_new/trunk/scripts/ZoneMinder/lib/ZoneMinder/ConfigData.pm.in	2011-04-01 20:00:17.000000000 +0200
@@ -542,6 +542,46 @@
 		category => "paths",
 	},
 	{
+		name => "ZM_PATH_PLUGINS",
+		default => "/usr/share/zoneminder",
+		description => "Path to the plugin folder",
+		help => "3d-party plugins have to be placed here.",
+		type => $types{abs_path},
+		category => "paths",
+	},
+	{
+		name => "ZM_PLUGIN_EXTENSION",
+		default => ".zmpl",
+		description => "Default extension of plugins to found.",
+		help => "Default extension of plugins to found.",
+		type => $types{rel_path},
+		category => "paths",
+	},
+	{
+		name => "ZM_PLUGINS_CONFIG_FILE",
+		default => "/usr/share/zoneminder/plugins.conf",
+		description => "Path to the config file for plugins.",
+		help => "Path to the config file for plugins.",
+		type => $types{abs_path},
+		category => "paths",
+	},
+	{
+		name => "ZM_LOAD_PLUGINS",
+		default => "no",
+		description => "Load and use 3d-party plugins",
+		help => "3d-party plugins will be loaded and used for analysing.",
+		type => $types{boolean},
+		category => "config",
+	},
+	{
+		name => "ZM_TURNOFF_NATIVE_ANALYSIS",
+		default => "no",
+		description => "Turn native ZM\'s image analysis possibility off",
+		help => "Image analysis with ZM\'s motion detected function will be turned off. Only detection functions from loaded plugins will be used. Note, that if no plugins have be loaded, no detection will be done.",
+		type => $types{boolean},
+		category => "config",
+	},
+	{
 		name => "ZM_PATH_SWAP",
 		default => "@ZM_TMPDIR@",
 		description => "Path to location for temporary swap images used in streaming",
diff -aurN zoneminder/trunk/src/Makefile.am zoneminder_new/trunk/src/Makefile.am
--- zoneminder/trunk/src/Makefile.am	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/Makefile.am	2011-04-01 17:10:30.000000000 +0200
@@ -58,7 +58,11 @@
 	zm_timer.cpp \
 	zm_user.cpp \
 	zm_utils.cpp \
-	zm_zone.cpp
+	zm_zone.cpp \
+	zm_detector.cpp \
+	zm_plugin.cpp \
+	zm_plugin_manager.cpp \
+	zm_image_analyser.cpp
 
 zmc_SOURCES = zmc.cpp $(zm_SOURCES)
 zma_SOURCES = zma.cpp $(zm_SOURCES)
@@ -113,7 +117,11 @@
 	zm_timer.h \
 	zm_user.h \
 	zm_utils.h \
-	zm_zone.h
+	zm_zone.h \
+	zm_detector.h \
+	zm_plugin.h \
+	zm_plugin_manager.h \
+	zm_image_analyser.h
 
 EXTRA_DIST = \
 	zm_config.h.in \
diff -aurN zoneminder/trunk/src/zm_config_defines.h zoneminder_new/trunk/src/zm_config_defines.h
--- zoneminder/trunk/src/zm_config_defines.h	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_config_defines.h	2011-04-01 17:18:50.000000000 +0200
@@ -198,9 +198,13 @@
 #define ZM_EYEZM_H264_DEFAULT_EVBR 194
 #define ZM_EYEZM_H264_TIMEOUT 195
 #define ZM_EYEZM_SEG_DURATION 196
+#define ZM_PATH_PLUGINS 197
+#define ZM_PLUGIN_EXTENSION 198
+#define ZM_PLUGINS_CONFIG_FILE 199
+#define ZM_LOAD_PLUGINS 200
+#define ZM_TURNOFF_NATIVE_ANALYSIS 201
 
-
-#define ZM_MAX_CFG_ID 196
+#define ZM_MAX_CFG_ID 201
 
 #define ZM_CFG_DECLARE_LIST \
 	const char *lang_default;\
@@ -257,6 +261,11 @@
 	const char *path_map;\
 	const char *path_socks;\
 	const char *path_logs;\
+	const char *path_plugins;\
+    const char *plugin_extension;\
+    const char *plugins_config_path;\
+    bool load_plugins;\
+    bool turnoff_native_analysis;\
 	const char *path_swap;\
 	const char *web_title_prefix;\
 	bool web_resize_console;\
@@ -457,6 +466,11 @@
 	path_map = (const char *)config.Item( ZM_PATH_MAP );\
 	path_socks = (const char *)config.Item( ZM_PATH_SOCKS );\
 	path_logs = (const char *)config.Item( ZM_PATH_LOGS );\
+	path_plugins = (const char *)config.Item( ZM_PATH_PLUGINS );\
+    plugin_extension = (const char *)config.Item( ZM_PLUGIN_EXTENSION );\
+    plugins_config_path = (const char *)config.Item( ZM_PLUGINS_CONFIG_FILE );\
+    load_plugins = (bool)config.Item( ZM_LOAD_PLUGINS );\
+    turnoff_native_analysis = (bool)config.Item( ZM_TURNOFF_NATIVE_ANALYSIS );\
 	path_swap = (const char *)config.Item( ZM_PATH_SWAP );\
 	web_title_prefix = (const char *)config.Item( ZM_WEB_TITLE_PREFIX );\
 	web_resize_console = (bool)config.Item( ZM_WEB_RESIZE_CONSOLE );\
diff -aurN zoneminder/trunk/src/zm_detector.cpp zoneminder_new/trunk/src/zm_detector.cpp
--- zoneminder/trunk/src/zm_detector.cpp	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_detector.cpp	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,200 @@
+#include "zm_detector.h"
+
+
+
+/*!\fn Detector::Detector(const Detector& source)
+ * \param source is the object to copy
+ */
+Detector::Detector(const Detector& source)
+  : m_sDetectionCause(source.m_sDetectionCause),
+    m_fMinAlarmScore(source.m_fMinAlarmScore),     
+    m_fMaxAlarmScore(source.m_fMaxAlarmScore),
+    m_fImageScaleFactor(source.m_fImageScaleFactor),
+    m_sLogPrefix(source.m_sLogPrefix),
+    m_nNewWidth(source.m_nNewWidth),
+    m_nNewHeight(source.m_nNewHeight),
+    m_sConfigSectionName(source.m_sConfigSectionName)
+{
+    //setlogmask (LOG_UPTO (LOG_LEVEL));
+    //openlog(m_sLogPrefix.c_str(), LOG_PID|LOG_CONS, LOG_USER);
+}
+
+
+
+/*!\fn Detector& ImageAnalyser::Detector::operator=(const ImageAnalyser::Detector& source)
+ * \param source is the object to copy
+ */
+Detector& Detector::operator=(const Detector& source)
+{
+    m_sDetectionCause = source.m_sDetectionCause;
+    m_fMinAlarmScore = source.m_fMinAlarmScore; 
+    m_fMaxAlarmScore = source.m_fMaxAlarmScore;
+    m_fImageScaleFactor = source.m_fImageScaleFactor;
+    m_sLogPrefix = source.m_sLogPrefix;
+    m_nNewWidth = source.m_nNewWidth;
+    m_nNewHeight = source.m_nNewHeight;
+    m_sConfigSectionName = source.m_sConfigSectionName;
+
+    //setlogmask (LOG_UPTO (LOG_LEVEL));
+    //openlog(m_sLogPrefix.c_str(), LOG_PID|LOG_CONS, LOG_USER);
+
+    return *this;
+}
+
+
+
+/*!\fn Detector::getDetectionCause()
+ * return detection cause as string
+ */
+string Detector::getDetectionCause() 
+{
+    return m_sDetectionCause;
+}
+
+
+
+
+/*! \fn Detector::log(int nLogLevel, string sMessage)
+ */
+void Detector::log(int nLogLevel, string sMessage)
+{
+    string sMessageToLog = m_sLogPrefix + string(" : ") + sMessage;
+    syslog(nLogLevel, sMessageToLog.c_str());
+}
+
+
+//Detector::~Detector() {}
+
+
+
+
+/*! \fn int FaceDetectorPlugin::Detect(const Image &image, Event::StringSet &zoneSet)
+ *  \param image is an image to detect faces on
+ *  \param zoneSet is set of zone names (see zm_zone.h)
+ *  \return detection score
+ */
+int Detector::Detect(const Image &zmImage, Zone** zones, int n_numZones, Event::StringSet &zoneSet)
+{
+    //log(LOG_LEVEL, "Detection invoking.");
+    bool alarm = false;
+    char szMessage[50];
+    unsigned int score = 0;
+
+    if (n_numZones <= 0) return (alarm);
+
+
+//    // Blank out all exclusion zones
+//    for ( int n_zone = 0; n_zone < n_zones; n_zone++ )
+//    {
+//        Zone *zone = zones[n_zone];
+//        zone->ClearAlarm();
+//        if ( !zone->IsInactive() )
+//        {
+//            continue;
+//        }
+//        Debug( 3, "Blanking inactive zone %s", zone->Label() );
+//        delta_image->Fill( RGB_BLACK, zone->GetPolygon() );
+//    }
+
+    // Check preclusive zones first 
+    for (int n_zone = 0; n_zone < n_numZones; n_zone++)
+    {
+        Zone *zone = zones[n_zone];
+        if (!zone->IsPreclusive())
+        {
+            continue;
+        }
+        sprintf(szMessage, "Checking preclusive zone %s", zone->Label());
+        log(LOG_DEBUG, szMessage);
+        if (checkZone(zone, &zmImage))
+        {
+            alarm = true;
+            score += zone->Score();
+            zone->SetAlarm();
+            sprintf(szMessage, "Zone is alarmed, zone score = %d", zone->Score());
+            log(LOG_DEBUG, szMessage);
+            zoneSet.insert(zone->Label());
+        }
+    }
+
+    if ( alarm )
+    {
+        alarm = false;
+        score = 0;
+    }
+    else
+    {
+        // Find all alarm pixels in active zones
+        for (int n_zone = 0; n_zone < n_numZones; n_zone++)
+        {
+            Zone *zone = zones[n_zone];
+            if (!zone->IsActive())
+            {
+                continue;
+            }
+            sprintf(szMessage, "Checking active zone %s", zone->Label());
+            log(LOG_DEBUG, szMessage);
+            if (checkZone(zone, &zmImage))
+            {
+                alarm = true;
+                score += zone->Score();
+                zone->SetAlarm();
+                sprintf(szMessage, "Zone is alarmed, zone score = %d", zone->Score());
+                log(LOG_DEBUG, szMessage);
+                zoneSet.insert(zone->Label());
+            }
+        }
+
+        if ( alarm )
+        {
+            // Checking inclusive zones
+            for (int n_zone = 0; n_zone < n_numZones; n_zone++)
+            {
+                Zone *zone = zones[n_zone];
+                if (!zone->IsInclusive())
+                {
+                    continue;
+                }
+                sprintf(szMessage, "Checking inclusive zone %s", zone->Label());
+                log(LOG_DEBUG, szMessage);
+                if (checkZone(zone, &zmImage))
+                {
+                    alarm = true;
+                    score += zone->Score();
+                    zone->SetAlarm();
+                    sprintf(szMessage, "Zone is alarmed, zone score = %d", zone->Score());
+                    log(LOG_DEBUG, szMessage);
+                    zoneSet.insert(zone->Label());
+                }
+            }
+        }
+        else
+        {
+            // Find all alarm pixels in exclusive zones
+            for (int n_zone = 0; n_zone < n_numZones; n_zone++)
+            {
+                Zone *zone = zones[n_zone];
+                if (!zone->IsExclusive())
+                {
+                    continue;
+                }
+                sprintf(szMessage, "Checking exclusive zone %s", zone->Label());
+                log(LOG_DEBUG, szMessage);
+                if (checkZone(zone, &zmImage))
+                {
+                    alarm = true;
+                    score += zone->Score();
+                    zone->SetAlarm();
+                    sprintf(szMessage, "Zone is alarmed, zone score = %d", zone->Score());
+                    log(LOG_DEBUG, szMessage);
+                    zoneSet.insert(zone->Label());
+                }
+            }
+        } //else if(alarm) : exclusive
+    } //else if(alarm)
+
+
+    return(score?score:alarm);
+}
+
+
diff -aurN zoneminder/trunk/src/zm_detector.h zoneminder_new/trunk/src/zm_detector.h
--- zoneminder/trunk/src/zm_detector.h	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_detector.h	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,129 @@
+#ifndef ZM_DETECTOR_H
+#define ZM_DETECTOR_H
+
+
+#include <string>
+#include <syslog.h>
+#include <libgen.h>
+
+#include "zm_image.h"
+#include "zm_zone.h"
+#include "zm_event.h"
+
+
+
+#define DEFAULT_DETECTION_CAUSE "Object Detected"
+#define DEFAULT_MIN_ALARM_SCORE 1.0
+#define DEFAULT_MAX_ALARM_SCORE 99.0
+#define DEFAULT_IMAGE_SCALE_FACTOR 1.0
+
+#define DEFAULT_LOG_PREFIX "ZM PLUGIN"
+#define LOG_LEVEL LOG_NOTICE
+#define DEFAULT_CONFIGFILE_SECTION "libzm_vscvl_plugin"
+
+using namespace std;
+
+
+//! Base class for object detectors, defined in plugins.
+class Detector 
+{
+
+public:
+    
+    //! Destructor
+    virtual ~Detector() { closelog(); }
+    
+    //! Default constructor
+    Detector()
+{
+    m_sLogPrefix = DEFAULT_LOG_PREFIX;
+
+    //setlogmask (LOG_UPTO (LOG_LEVEL));
+    //openlog(m_sLogPrefix.c_str(), LOG_PID|LOG_CONS, LOG_USER);
+
+    m_sDetectionCause = DEFAULT_DETECTION_CAUSE;
+    m_fMinAlarmScore = DEFAULT_MIN_ALARM_SCORE;
+    m_fMaxAlarmScore = DEFAULT_MAX_ALARM_SCORE;
+    m_fImageScaleFactor = DEFAULT_IMAGE_SCALE_FACTOR;
+    m_sConfigSectionName = DEFAULT_CONFIGFILE_SECTION;
+    m_nNewWidth = 0;
+    m_nNewHeight = 0;
+}
+
+    //! Constructor with section name parameter.
+    Detector(string sPluginFileName)
+{
+    m_sLogPrefix = DEFAULT_LOG_PREFIX;
+
+    char* szPluginFileName = strdup(sPluginFileName.c_str());
+
+    string sPluginFileNameName = string(basename(szPluginFileName));
+
+    size_t idx = sPluginFileNameName.rfind('.');
+
+    if (idx == string::npos)
+        m_sConfigSectionName = sPluginFileNameName;
+    else
+        m_sConfigSectionName = sPluginFileNameName.substr(0, idx);
+
+    m_sDetectionCause = DEFAULT_DETECTION_CAUSE;
+    m_fMinAlarmScore = DEFAULT_MIN_ALARM_SCORE;
+    m_fMaxAlarmScore = DEFAULT_MAX_ALARM_SCORE;
+    m_fImageScaleFactor = DEFAULT_IMAGE_SCALE_FACTOR;
+    m_nNewWidth = 0;
+    m_nNewHeight = 0;
+}
+
+    //! Copy constructor
+    Detector(const Detector& source);
+
+    //! Assignment operator
+    Detector& operator=(const Detector& source);
+
+    //! Detect (in an image later)
+    int Detect(const Image &image, Zone** zones, int n_numZones, Event::StringSet &zoneSet);
+
+    //! Load detector's parameters from a config file.
+    virtual void loadConfig(string sConfigFileName) = 0;
+
+    //! Returns detection case string.
+    string getDetectionCause();
+
+protected:
+
+    //! Do detection inside one given zone.
+    virtual bool checkZone(Zone *zone, const Image *zmImage) = 0;
+
+    //! Log messages to the SYSLOG.
+    void log(int, string sMessage);
+
+    //! String to be shown as detection cause for event.
+    string m_sDetectionCause;
+
+    //! Minimum score value to consider frame as to be alarmed.
+    double m_fMinAlarmScore;
+
+    //! Maximum score value to consider frame as to be alarmed.
+    double m_fMaxAlarmScore;
+
+    //! Maximum allowed width of frame image.
+    double m_fImageScaleFactor;
+
+    //! Width of image to resize.
+    int m_nNewWidth;
+
+    //! Height of image to resize.
+    int m_nNewHeight;
+//
+//    //! Output stream for logging errors.
+//    ofstream m_outStream;
+
+    //! String prefix for SYSLOG messages.
+    string m_sLogPrefix;
+
+    //! Name of config file section to search parameters.
+    string m_sConfigSectionName;
+};
+
+
+#endif // ZM_DETECTOR_H
diff -aurN zoneminder/trunk/src/zm_event.h zoneminder_new/trunk/src/zm_event.h
--- zoneminder/trunk/src/zm_event.h	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_event.h	2011-04-01 17:10:30.000000000 +0200
@@ -41,7 +41,7 @@
 class Zone;
 class Monitor;
 
-#define MAX_PRE_ALARM_FRAMES	16 // Maximum number of prealarm frames that can be stored
+#define MAX_PRE_ALARM_FRAMES 16 // Maximum number of prealarm frames that can be stored
 
 //
 // Class describing events, i.e. captured periods of activity.
diff -aurN zoneminder/trunk/src/zm_image_analyser.cpp zoneminder_new/trunk/src/zm_image_analyser.cpp
--- zoneminder/trunk/src/zm_image_analyser.cpp	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_image_analyser.cpp	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,86 @@
+#include "zm_image_analyser.h"
+
+
+
+/*!\fn ImageAnalyser::ImageAnalyser(const ImageAnalyser& source)
+ * \param source is the object to copy
+ */
+ImageAnalyser::ImageAnalyser(const ImageAnalyser& source)
+{
+    m_Detectors = source.m_Detectors;
+}
+
+
+
+/*!\fn ImageAnalyser::operator=(const ImageAnalyser& source)
+ * \param source is the object to copy
+ */
+ImageAnalyser& ImageAnalyser::operator=(const ImageAnalyser& source)
+{
+    m_Detectors = source.m_Detectors;
+    return *this;
+}
+
+
+
+ImageAnalyser::~ImageAnalyser()
+{
+    for(DetectorsList::reverse_iterator It = m_Detectors.rbegin();
+        It != m_Detectors.rend();
+        ++It)
+      delete *It;
+}
+
+
+
+/*!\fn ImageAnalyser::DoDetection(const Image &comp_image, Zone** zones, int n_numZones, Event::StringSetMap noteSetMap, std::string& det_cause)
+ * \param comp_image is the image to analyse
+ * \param zones is the zones array to analyse
+ * \param n_numZones is the number of zones
+ * \param noteSetMap is the map of events descriptions
+ * \param det_cause is a string describing detection cause
+ */
+int ImageAnalyser::DoDetection(const Image &comp_image, Zone** zones, int n_numZones, Event::StringSetMap noteSetMap, std::string& det_cause)
+{
+    Event::StringSet zoneSet;
+    int score = 0;
+
+    for(DetectorsList::iterator It = m_Detectors.begin();
+        It != m_Detectors.end();
+        ++It)
+    {
+        int detect_score = (*It)->Detect(comp_image, zones, n_numZones, zoneSet);
+        if (detect_score)
+        {
+            score += detect_score;
+            noteSetMap[(*It)->getDetectionCause()] = zoneSet;
+            if (det_cause.length())
+                det_cause += ", ";
+            det_cause += (*It)->getDetectionCause();
+        }
+    }
+    return score;
+}
+
+
+
+/*!\fn ImageAnalyser::configurePlugins(string sConfigFileName)
+ *  \param sConfigFileName is the path to the configuration file, where parameters for all plugins are given.
+ */
+void ImageAnalyser::configurePlugins(string sConfigFileName)
+{
+    for(DetectorsList::iterator It = m_Detectors.begin();
+        It != m_Detectors.end();
+        ++It)
+    {
+        try
+        {
+            (*It)->loadConfig(sConfigFileName);
+        }
+        catch(...)
+        {
+            Info("ERROR: Plugin \"%s\" couldn\'t load config file \"%s\".", (*It)->getDetectionCause(), sConfigFileName.c_str());
+        }
+    }
+
+}
diff -aurN zoneminder/trunk/src/zm_image_analyser.h zoneminder_new/trunk/src/zm_image_analyser.h
--- zoneminder/trunk/src/zm_image_analyser.h	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_image_analyser.h	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,65 @@
+#ifndef ZM_IMAGE_ANALYSER_H
+#define ZM_IMAGE_ANALYSER_H
+
+
+
+#include <list>
+#include <string>
+#include <stdexcept>
+#include <iostream>
+#include <memory>
+
+#include "zm.h"
+#include "zm_detector.h"
+#include "zm_image.h"
+#include "zm_zone.h"
+#include "zm_event.h"
+
+
+
+using namespace std;
+
+
+//! List of available detectors.
+typedef std::list<Detector *> DetectorsList;
+
+
+//! Class for handling image detection.
+/*! Contains all detectors loaded from plugins.
+ */
+class ImageAnalyser {
+  public:
+    
+    //!Default constructor.
+    ImageAnalyser() {};
+
+    //! Destructor.
+    ~ImageAnalyser();
+
+    //! Copy constructor.
+    ImageAnalyser(const ImageAnalyser& source);
+
+    //! Overloaded operator=.
+    ImageAnalyser& operator=(const ImageAnalyser& source);
+
+    //! Adds new plugin's detector to the list of detectors.
+    void addDetector(std::auto_ptr<Detector> Det)
+    {
+        m_Detectors.push_back(Det.release());
+    }
+    
+    //! Do detection in an image by calling all available detectors.
+    int DoDetection(const Image &comp_image, Zone** zones, int n_numZones, Event::StringSetMap noteSetMap, std::string& det_cause);
+
+    //! Configure all loaded plugins using given configuration file.
+    void configurePlugins(string sConfigFileName);
+
+private: 
+
+    //! All available detectors.
+    DetectorsList m_Detectors;
+};
+
+
+
+#endif //ZM_IMAGE_ANALYSER_H
diff -aurN zoneminder/trunk/src/zm_monitor.cpp zoneminder_new/trunk/src/zm_monitor.cpp
--- zoneminder/trunk/src/zm_monitor.cpp	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_monitor.cpp	2011-04-01 17:35:20.000000000 +0200
@@ -49,6 +49,37 @@
 #include <sys/shm.h>
 #endif // ZM_MEM_MAPPED
 
+
+//=============================================================================
+std::string trimSpaces(std::string str)
+{
+    // Trim Both leading and trailing spaces
+    size_t startpos = str.find_first_not_of(" \t"); // Find the first character position after excluding leading blank spaces
+    size_t endpos = str.find_last_not_of(" \t"); // Find the first character position from reverse af
+ 
+    // if all spaces or empty return an empty string
+    if(( std::string::npos == startpos ) || ( std::string::npos == endpos))
+    {
+        return std::string("");
+    }
+    else
+        return str.substr( startpos, endpos-startpos+1 );
+}
+
+
+std::vector<std::string> split(const std::string &s, char delim) {
+    std::vector<std::string> elems;
+    std::stringstream ss(s);
+    std::string item;
+    while(std::getline(ss, item, delim)) {
+        elems.push_back(trimSpaces(item));
+    }
+    return elems;
+}
+//=============================================================================
+
+
+
 Monitor::MonitorLink::MonitorLink( int p_id, const char *p_name ) : id( p_id )
 {
     strncpy( name, p_name, sizeof(name) );
@@ -263,7 +294,9 @@
     Rgb p_signal_check_colour,
     Purpose p_purpose,
     int p_n_zones,
-    Zone *p_zones[]
+    Zone *p_zones[],
+    std::string p_sPlugins,
+    bool p_DoNativeMotDet
 ) : id( p_id ),
     function( (Function)p_function ),
     enabled( p_enabled ),
@@ -290,7 +323,8 @@
     purpose( p_purpose ),
     camera( p_camera ),
     n_zones( p_n_zones ),
-    zones( p_zones )
+    zones( p_zones ),
+    m_bDoNativeMotDet(p_DoNativeMotDet)
 {
     strncpy( name, p_name, sizeof(name) );
 
@@ -392,6 +426,12 @@
     trigger_data = (TriggerData *)((char *)shared_data + sizeof(SharedData));
     struct timeval *shared_timestamps = (struct timeval *)((char *)trigger_data + sizeof(TriggerData));
     unsigned char *shared_images = (unsigned char *)((char *)shared_timestamps + (image_buffer_count*sizeof(struct timeval)));
+    
+    //========================================================================================
+    // Get from string with plugins names particular names.
+    m_sPluginNames = split(p_sPlugins, ';');
+
+    //========================================================================================
 
     if ( purpose == CAPTURE )
     {
@@ -425,6 +465,32 @@
         shared_data->last_read_time = 0;
         shared_data->alarm_x = -1;
         shared_data->alarm_y = -1;
+
+        //========================================================================================
+        Info("In the constructor of Monitor class with ID=%d:", p_id);
+        if (config.load_plugins)
+        {
+            Info("Load plugins from the directory %s ... ", config.path_plugins);
+            std::string sPluginExt = std::string(config.plugin_extension);
+            ThePluginManager.setPluginExt(sPluginExt);
+            for (std::vector<std::string>::iterator it = m_sPluginNames.begin() ; it < m_sPluginNames.end(); it++ )
+            {
+                std::string sFullPluginPath = join_paths(config.path_plugins, *it + config.plugin_extension);
+                Info("Plugin path %s", sFullPluginPath.c_str());
+                ThePluginManager.loadPlugin(sFullPluginPath);
+            }
+
+//            int count_plugins = ThePluginManager.findPlugins(config.path_plugins);
+//            Info("Number of found plugins is %d", count_plugins);
+//            if (count_plugins > 0)
+//            {
+                std::string sPluginsConfig = std::string(config.plugins_config_path);
+                Info("Configure plugins with \'%s\' config file.", config.plugins_config_path);
+                ThePluginManager.configurePlugins(sPluginsConfig);
+//            }
+            
+        }
+        //========================================================================================
     }
 
     if ( !shared_data->valid )
@@ -1209,23 +1275,52 @@
                 }
                 else if ( signal && Active() && function != RECORD && function != NODECT )
                 {
-                    Event::StringSet zoneSet;
-                    int motion_score = DetectMotion( *snap_image, zoneSet );
-                    if ( motion_score )
-                    {
-                        if ( !event )
-                        {
-                            score += motion_score;
-                            if ( cause.length() )
-                                cause += ", ";
-                            cause += MOTION_CAUSE;
+                    if ((config.turnoff_native_analysis && !config.load_plugins) || (!config.turnoff_native_analysis && (m_bDoNativeMotDet || (!m_bDoNativeMotDet && !config.load_plugins))) )
+                    {
+                        Event::StringSet zoneSet;
+                        int motion_score = DetectMotion( *snap_image, zoneSet );
+                        //int motion_score = DetectBlack( *snap_image, zoneSet );
+                        if ( motion_score )
+                        {
+                            if ( !event )
+                            {
+                                score += motion_score;
+                                if ( cause.length() )
+                                    cause += ", ";
+                                cause += MOTION_CAUSE;
+                            }
+                            else
+                            {
+                                score += motion_score;
+                            }
+                            noteSetMap[MOTION_CAUSE] = zoneSet;
                         }
-                        else
+                    }
+                    //====================================================================
+                    else
+                    {
+                        
+                        for ( int n_zone = 0; n_zone < n_zones; n_zone++ )
                         {
-                            score += motion_score;
+                            zones[n_zone]->ResetStats();
                         }
-                        noteSetMap[MOTION_CAUSE] = zoneSet;
                     }
+
+                    if (config.load_plugins)
+                    {
+                        std::string det_cause; // detection cause to fill in plugin's detectors
+                        score += ThePluginManager.getImageAnalyser().DoDetection(*snap_image, zones, n_zones, noteSetMap, det_cause);
+                        if (!event)
+                        {
+                            if (det_cause.length())
+                            {
+                                if (cause.length())
+                                    cause += ", ";
+                                cause +=  det_cause;
+                            }
+                        }
+                    }
+                    //====================================================================
                     shared_data->active = signal;
                 }
                 if ( n_linked_monitors > 0 )
@@ -1547,7 +1642,7 @@
     closeEvent();
 
     static char sql[ZM_SQL_MED_BUFSIZ];
-    snprintf( sql, sizeof(sql), "select Function+0, Enabled, LinkedMonitors, EventPrefix, LabelFormat, LabelX, LabelY, WarmupCount, PreEventCount, PostEventCount, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, SignalCheckColour from Monitors where Id = '%d'", id );
+    snprintf( sql, sizeof(sql), "select Function+0, Enabled, LinkedMonitors, EventPrefix, LabelFormat, LabelX, LabelY, WarmupCount, PreEventCount, PostEventCount, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet, SignalCheckColour from Monitors where Id = '%d'", id );
     if ( mysql_query( &dbconn, sql ) )
     {
         Error( "Can't run query: %s", mysql_error( &dbconn ) );
@@ -1587,6 +1682,14 @@
         fps_report_interval = atoi(dbrow[index++]);
         ref_blend_perc = atoi(dbrow[index++]);
         track_motion = atoi(dbrow[index++]);
+        
+        //============================================================================
+        std::string plugins = dbrow[index]; index++;
+        m_sPluginNames = split(plugins ,';');
+        std::string sDoNativeMotDet = dbrow[index]; index++;
+        m_bDoNativeMotDet = !sDoNativeMotDet.compare("yes") ? true : false;
+        //============================================================================
+
         if ( dbrow[index][0] == '#' )
             signal_check_colour = strtol(dbrow[index]+1,0,16);
         else
@@ -1733,11 +1836,11 @@
     static char sql[ZM_SQL_MED_BUFSIZ];
     if ( !device[0] )
     {
-        strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Device, Channel, Format, Method, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, SignalCheckColour from Monitors where Function != 'None' and Type = 'Local' order by Device, Channel", sizeof(sql) );
+        strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Device, Channel, Format, Method, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet, SignalCheckColour from Monitors where Function != 'None' and Type = 'Local' order by Device, Channel", sizeof(sql) );
     }
     else
     {
-        snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Device, Channel, Format, Method, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, SignalCheckColour from Monitors where Function != 'None' and Type = 'Local' and Device = '%s' order by Channel", device );
+        snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Device, Channel, Format, Method, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet, SignalCheckColour from Monitors where Function != 'None' and Type = 'Local' and Device = '%s' order by Channel", device );
     }
     if ( mysql_query( &dbconn, sql ) )
     {
@@ -1798,6 +1901,13 @@
         int fps_report_interval = atoi(dbrow[col]); col++;
         int ref_blend_perc = atoi(dbrow[col]); col++;
         int track_motion = atoi(dbrow[col]); col++;
+        
+        //============================================================================
+        std::string plugins = dbrow[col]; col++;
+        std::string sDoNativeMotDet = dbrow[col]; col++;
+        bool doNativeMotDet = !sDoNativeMotDet.compare("yes") ? true : false;
+        //============================================================================
+
         int signal_check_colour;
         if ( dbrow[col][0] == '#' )
             signal_check_colour = strtol(dbrow[col]+1,0,16);
@@ -1849,7 +1959,11 @@
             ref_blend_perc,
             track_motion,
             signal_check_colour,
-            purpose
+            purpose,
+            0,
+            0,
+            plugins,
+            doNativeMotDet
         );
         Zone **zones = 0;
         int n_zones = Zone::Load( monitors[i], zones );
@@ -1873,11 +1987,11 @@
     static char sql[ZM_SQL_MED_BUFSIZ];
     if ( !protocol )
     {
-        strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Protocol, Method, Host, Port, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion from Monitors where Function != 'None' and Type = 'Remote'", sizeof(sql) );
+        strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Protocol, Method, Host, Port, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet from Monitors where Function != 'None' and Type = 'Remote'", sizeof(sql) );
     }
     else
     {
-        snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Protocol, Method, Host, Port, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion from Monitors where Function != 'None' and Type = 'Remote' and Protocol = '%s' and Host = '%s' and Port = '%s' and Path = '%s'", protocol, host, port, path );
+        snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Protocol, Method, Host, Port, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet from Monitors where Function != 'None' and Type = 'Remote' and Protocol = '%s' and Host = '%s' and Port = '%s' and Path = '%s'", protocol, host, port, path );
     }
     if ( mysql_query( &dbconn, sql ) )
     {
@@ -1939,6 +2053,13 @@
         int fps_report_interval = atoi(dbrow[col]); col++;
         int ref_blend_perc = atoi(dbrow[col]); col++;
         int track_motion = atoi(dbrow[col]); col++;
+        
+        //============================================================================
+        std::string plugins = dbrow[col]; col++;
+        std::string sDoNativeMotDet = dbrow[col]; col++;
+        bool doNativeMotDet = !sDoNativeMotDet.compare("yes") ? true : false;
+        //============================================================================
+
 
         int cam_width = ((orientation==ROTATE_90||orientation==ROTATE_270)?height:width);
         int cam_height = ((orientation==ROTATE_90||orientation==ROTATE_270)?width:height);
@@ -2012,7 +2133,11 @@
             ref_blend_perc,
             track_motion,
             RGB_WHITE,
-            purpose
+            purpose,
+            0,
+            0,
+            plugins,
+            doNativeMotDet
         );
         Zone **zones = 0;
         int n_zones = Zone::Load( monitors[i], zones );
@@ -2035,11 +2160,11 @@
     static char sql[ZM_SQL_MED_BUFSIZ];
     if ( !file[0] )
     {
-        strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion from Monitors where Function != 'None' and Type = 'File'", sizeof(sql) );
+	strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet from Monitors where Function != 'None' and Type = 'File'", sizeof(sql) );
     }
     else
     {
-        snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion from Monitors where Function != 'None' and Type = 'File' and Path = '%s'", file );
+	snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet from Monitors where Function != 'None' and Type = 'File' and Path = '%s'", file );
     }
     if ( mysql_query( &dbconn, sql ) )
     {
@@ -2097,6 +2222,13 @@
         int fps_report_interval = atoi(dbrow[col]); col++;
         int ref_blend_perc = atoi(dbrow[col]); col++;
         int track_motion = atoi(dbrow[col]); col++;
+        
+        //============================================================================
+        std::string plugins = dbrow[col]; col++;
+        std::string sDoNativeMotDet = dbrow[col]; col++;
+        bool doNativeMotDet = !sDoNativeMotDet.compare("yes") ? true : false;
+        //============================================================================
+
 
         int cam_width = ((orientation==ROTATE_90||orientation==ROTATE_270)?height:width);
         int cam_height = ((orientation==ROTATE_90||orientation==ROTATE_270)?width:height);
@@ -2139,7 +2271,11 @@
             ref_blend_perc,
             track_motion,
             RGB_WHITE,
-            purpose
+            purpose,
+            0,
+            0,
+            plugins,
+            doNativeMotDet
         );
         Zone **zones = 0;
         int n_zones = Zone::Load( monitors[i], zones );
@@ -2163,11 +2299,11 @@
     static char sql[ZM_SQL_MED_BUFSIZ];
     if ( !file[0] )
     {
-        strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion from Monitors where Function != 'None' and Type = 'Ffmpeg'", sizeof(sql) );
+	strncpy( sql, "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet from Monitors where Function != 'None' and Type = 'Ffmpeg'", sizeof(sql) );
     }
     else
     {
-        snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion from Monitors where Function != 'None' and Type = 'Ffmpeg' and Path = '%s'", file );
+	snprintf( sql, sizeof(sql), "select Id, Name, Function+0, Enabled, LinkedMonitors, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet from Monitors where Function != 'None' and Type = 'Ffmpeg' and Path = '%s'", file );
     }
     if ( mysql_query( &dbconn, sql ) )
     {
@@ -2225,6 +2361,13 @@
         int fps_report_interval = atoi(dbrow[col]); col++;
         int ref_blend_perc = atoi(dbrow[col]); col++;
         int track_motion = atoi(dbrow[col]); col++;
+        
+        //============================================================================
+        std::string plugins = dbrow[col]; col++;
+        std::string sDoNativeMotDet = dbrow[col]; col++;
+        bool doNativeMotDet = !sDoNativeMotDet.compare("yes") ? true : false;
+        //============================================================================
+
 
         int cam_width = ((orientation==ROTATE_90||orientation==ROTATE_270)?height:width);
         int cam_height = ((orientation==ROTATE_90||orientation==ROTATE_270)?width:height);
@@ -2267,7 +2410,11 @@
             ref_blend_perc,
             track_motion,
             RGB_WHITE,
-            purpose
+            purpose,
+            0,
+            0,
+            plugins,
+            doNativeMotDet
         );
         Zone **zones = 0;
         int n_zones = Zone::Load( monitors[i], zones );
@@ -2288,8 +2435,9 @@
 
 Monitor *Monitor::Load( int id, bool load_zones, Purpose purpose )
 {
+Info("Load monitor %d, purpose = %d", id, purpose);
     static char sql[ZM_SQL_MED_BUFSIZ];
-    snprintf( sql, sizeof(sql), "select Id, Name, Type, Function+0, Enabled, LinkedMonitors, Device, Channel, Format, Protocol, Method, Host, Port, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, SignalCheckColour from Monitors where Id = %d", id );
+    snprintf( sql, sizeof(sql), "select Id, Name, Type, Function+0, Enabled, LinkedMonitors, Device, Channel, Format, Protocol, Method, Host, Port, Path, Width, Height, Palette, Orientation+0, Brightness, Contrast, Hue, Colour, EventPrefix, LabelFormat, LabelX, LabelY, ImageBufferCount, WarmupCount, PreEventCount, PostEventCount, StreamReplayBuffer, AlarmFrameCount, SectionLength, FrameSkip, MaxFPS, AlarmMaxFPS, FPSReportInterval, RefBlendPerc, TrackMotion, UsedPl, DoNativeMotDet, SignalCheckColour from Monitors where Id = %d", id );
     if ( mysql_query( &dbconn, sql ) )
     {
         Error( "Can't run query: %s", mysql_error( &dbconn ) );
@@ -2305,6 +2453,7 @@
     int n_monitors = mysql_num_rows( result );
     Debug( 1, "Got %d monitors", n_monitors );
     Monitor *monitor = 0;
+
     for( int i = 0; MYSQL_ROW dbrow = mysql_fetch_row( result ); i++ )
     {
         int col = 0;
@@ -2354,6 +2503,13 @@
         int fps_report_interval = atoi(dbrow[col]); col++;
         int ref_blend_perc = atoi(dbrow[col]); col++;
         int track_motion = atoi(dbrow[col]); col++;
+        
+        //============================================================================
+        std::string plugins = dbrow[col]; col++;
+        std::string sDoNativeMotDet = dbrow[col]; col++;
+        bool doNativeMotDet = !sDoNativeMotDet.compare("yes") ? true : false;
+        //============================================================================
+
         int signal_check_colour;
         if ( dbrow[col][0] == '#' )
             signal_check_colour = strtol(dbrow[col]+1,0,16);
@@ -2496,7 +2652,11 @@
             ref_blend_perc,
             track_motion,
             signal_check_colour,
-            purpose
+            purpose,
+            0,
+            0,
+            plugins,
+            doNativeMotDet
         );
 
         int n_zones = 0;
@@ -2680,6 +2840,166 @@
     return( false );
 }
 
+//-----------------------------------------
+
+bool Monitor::OurCheckAlarms( Zone *zone, const Image *pImage )
+{
+    Info("Entering OurCheckAlarms >>>>>>>>>>>>>>>>>>>>>>>>>>>>");
+    unsigned char black_thr = 23;
+    int min_alarm_score = 10;
+    int max_alarm_score = 99;
+    //bool alarm = false;
+    unsigned int score;
+    Polygon zone_polygon = zone->GetPolygon();
+    Info("Got polygon of a zone. It has %d vertices.", zone_polygon.getNumCoords());
+
+	zone->ResetStats();
+    Info("ResetStats done.");
+
+    if ( !zone->CheckOverloadCount() )
+    {
+        Info("CheckOverloadCount() return false, we'll return false.");
+        return( false );
+    }
+
+    Image *pMaskImage = new Image(pImage->Width(), pImage->Height(), 1);
+    Info("Mask image created.");
+ 
+    pMaskImage->Fill(BLACK);
+    Info("Mask image filled with BLACK.");
+
+    if (pImage->Colours() == 1)
+    {
+        Info("Analysed image is not colored! Set score = 0.");
+        score = 0;
+    }
+    else
+    {
+        Info("Start processing image.");
+        //Process image
+        unsigned char *buffer = pImage->Buffer();
+        unsigned char *mask_buffer = pMaskImage->Buffer();
+        
+        int black_pixels_count = 0;
+        Info("Loop for black pixels counting and mask filling.");
+
+        while (buffer < (pImage->Buffer() + pImage->Size()))
+        {
+            if ( (RED(buffer) < black_thr) && (GREEN(buffer) < black_thr) && (BLUE(buffer) < black_thr) )
+            {
+                *mask_buffer = WHITE;
+                black_pixels_count++;
+            }
+            buffer += 3;
+            mask_buffer++;
+        }
+
+        if ( !black_pixels_count )
+        {
+            delete pMaskImage;
+            return( false );
+        }
+
+        score = (100*black_pixels_count)/zone_polygon.Area();
+        Info("Number of black pixels is %d, zone polygon area is %d, score is %d", black_pixels_count, zone_polygon.Area(), score);
+
+        if ( min_alarm_score && ( score < min_alarm_score) )
+        {
+            delete pMaskImage;
+            return( false );
+        }
+        if ( max_alarm_score && (score > max_alarm_score) )
+        {
+            zone->SetOverloadCount(zone->GetOverloadFrames());
+            delete pMaskImage;
+            return( false );
+        }
+    }
+
+    zone->SetScore(score);
+    Info("Score have been set in zone.");
+
+    //Get mask
+    Rgb alarm_colour = RGB_RED;
+	Image *tempImage = pMaskImage->HighlightEdges(alarm_colour, &zone_polygon.Extent() );
+    Info("After HighlightEdges");
+
+    zone->SetAlarmImage(tempImage);
+    Info("After SetAlarmImage");
+    delete pMaskImage;
+    Info("After Delete pMaskImage");
+    delete tempImage;
+
+    Info("Leaving OurCheckAlarms >>>>>>>>>>>>>>>>>>>>>>>>>>>>");
+    return true;
+}
+
+
+unsigned int Monitor::DetectBlack(const Image &comp_image, Event::StringSet &zoneSet )
+{
+    Info("Entering DetectBlack >>>>>>>>>>>>>>>>>>>>>>>>>>");
+    bool alarm = false;
+    unsigned int score = 0;
+
+    if ( n_zones <= 0 ) return( alarm );
+
+//    Coord alarm_centre;
+//    int top_score = -1;
+
+    // Find all alarm pixels in active zones
+    Info("Number of zones to process %d", n_zones);
+    for ( int n_zone = 0; n_zone < n_zones; n_zone++ )
+    {
+        Zone *zone = zones[n_zone];
+        if ( !zone->IsActive() )
+        {
+            continue;
+        }
+        Debug( 3, "Checking active zone %s", zone->Label() );
+        Info( "Checking active zone %s", zone->Label() );
+        if ( OurCheckAlarms( zone, &comp_image ) )
+        {
+            Info("OurCheckAlarm is TRUE!!!!!!");
+            alarm = true;
+            score += zone->Score();
+            zone->SetAlarm();
+            Debug( 3, "Zone is alarmed, zone score = %d", zone->Score() );
+            Info( "Zone is alarmed, zone score = %d", zone->Score() );
+            zoneSet.insert( zone->Label() );
+//            if ( config.opt_control && track_motion )
+//            {
+//                if ( (int)zone->Score() > top_score )
+//                {
+//                    top_score = zone->Score();
+//                    alarm_centre = zone->GetAlarmCentre();
+//                }
+//            }
+        }
+        Info( "Finish checking active zone %s", zone->Label() );
+    }
+
+
+//    if ( top_score > 0 )
+//    {
+//        shared_data->alarm_x = alarm_centre.X();
+//        shared_data->alarm_y = alarm_centre.Y();
+//
+//        Info( "Got alarm centre at %d,%d, at count %d", shared_data->alarm_x, shared_data->alarm_y, image_count );
+//    }
+//    else
+//    {
+//        shared_data->alarm_x = shared_data->alarm_y = -1;
+//    }
+
+    // This is a small and innocent hack to prevent scores of 0 being returned in alarm state
+    Info("Leaving DetectBlack <<<<<<<<<<<<<<<<<<<<<<<<<<<");
+    return( score?score:alarm );
+}
+
+
+//-----------------------------------------------------------------------------------------------
+
+
 unsigned int Monitor::DetectMotion( const Image &comp_image, Event::StringSet &zoneSet )
 {
     bool alarm = false;
diff -aurN zoneminder/trunk/src/zm_monitor.h zoneminder_new/trunk/src/zm_monitor.h
--- zoneminder/trunk/src/zm_monitor.h	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_monitor.h	2011-04-01 17:10:30.000000000 +0200
@@ -20,6 +20,9 @@
 #ifndef ZM_MONITOR_H
 #define ZM_MONITOR_H
 
+#include <vector>
+#include <sstream>
+
 #include "zm.h"
 #include "zm_coord.h"
 #include "zm_image.h"
@@ -27,6 +30,9 @@
 #include "zm_event.h"
 #include "zm_camera.h"
 
+#include "zm_plugin_manager.h"
+#include "zm_image_analyser.h"
+
 #include <sys/time.h>
 
 #define SIGNAL_CAUSE "Signal"
@@ -124,6 +130,13 @@
 		Image	*image;
 	};
 
+    //=========================================================================
+    PluginManager ThePluginManager;
+
+    std::vector<std::string> m_sPluginNames;
+    bool m_bDoNativeMotDet;
+    //============================================================================
+
 	class MonitorLink
 	{
 	protected:
@@ -253,7 +266,10 @@
 	MonitorLink		**linked_monitors;
 
 public:
-	Monitor( int p_id, const char *p_name, int p_function, bool p_enabled, const char *p_linked_monitors, Camera *p_camera, int p_orientation, const char *p_event_prefix, const char *p_label_format, const Coord &p_label_coord, int p_image_buffer_count, int p_warmup_count, int p_pre_event_count, int p_post_event_count, int p_stream_replay_buffer, int p_alarm_frame_count, int p_section_length, int p_frame_skip, int p_capture_delay, int p_alarm_capture_delay, int p_fps_report_interval, int p_ref_blend_perc, bool p_track_motion, Rgb p_signal_check_colour, Purpose p_purpose, int p_n_zones=0, Zone *p_zones[]=0 );
+//============================================================================
+bool OurCheckAlarms( Zone *zone, const Image *pImage );
+//============================================================================
+	Monitor( int p_id, const char *p_name, int p_function, bool p_enabled, const char *p_linked_monitors, Camera *p_camera, int p_orientation, const char *p_event_prefix, const char *p_label_format, const Coord &p_label_coord, int p_image_buffer_count, int p_warmup_count, int p_pre_event_count, int p_post_event_count, int p_stream_replay_buffer, int p_alarm_frame_count, int p_section_length, int p_frame_skip, int p_capture_delay, int p_alarm_capture_delay, int p_fps_report_interval, int p_ref_blend_perc, bool p_track_motion, Rgb p_signal_check_colour, Purpose p_purpose, int p_n_zones=0, Zone *p_zones[]=0, std::string plugins = "", bool p_DoNativeMotDect = 1);
 	~Monitor();
 
 	void AddZones( int p_n_zones, Zone *p_zones[] );
@@ -342,6 +358,9 @@
 	}
 
 	unsigned int DetectMotion( const Image &comp_image, Event::StringSet &zoneSet );
+    //==============================================================================
+	unsigned int DetectBlack( const Image &comp_image, Event::StringSet &zoneSet );
+    //==============================================================================
 	bool CheckSignal( const Image *image );
 	bool Analyse();
 	void DumpImage( Image *dump_image ) const;
diff -aurN zoneminder/trunk/src/zm_plugin.cpp zoneminder_new/trunk/src/zm_plugin.cpp
--- zoneminder/trunk/src/zm_plugin.cpp	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_plugin.cpp	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,103 @@
+#include "zm_plugin.h"
+
+
+
+/*!\fn Plugin::Plugin(const std::string &sFilename)
+ * \param sFilename is the name of plugin file to load
+ */
+Plugin::Plugin(const std::string &sFilename) 
+    :   m_hDLL(0),
+        m_pfnGetEngineVersion(0),
+        m_pfnRegisterPlugin(0),
+        m_pDLLRefCount(0),
+        m_sPluginFileName(sFilename)
+{
+  
+    // Try to load the plugin as a dynamic library
+    m_hDLL = dlopen(sFilename.c_str(), RTLD_LAZY|RTLD_GLOBAL);
+
+    if(!m_hDLL) // if library hasn't been loaded successfully
+    {
+        throw runtime_error(string("Could not load '") + sFilename + "'");
+    }
+
+    // Locate the plugin's exported functions  
+    try 
+    {
+        m_pfnGetEngineVersion = reinterpret_cast<fnGetEngineVersion *>(dlsym(m_hDLL, "getEngineVersion"));
+        m_pfnRegisterPlugin = reinterpret_cast<fnRegisterPlugin *>(dlsym(m_hDLL, "registerPlugin"));
+
+        // If the functions aren't found, we're going to assume this is
+        // a plain simple DLL and not one of our plugins
+        if(!m_pfnGetEngineVersion || ! m_pfnRegisterPlugin)
+            throw runtime_error(string("'") + sFilename + "' is not a valid plugin");
+
+        // Initialize a new DLL reference counter
+        m_pDLLRefCount = new size_t(1);
+    }
+    catch(runtime_error &ex)
+    {
+        dlclose(m_hDLL);
+        throw ex;
+    }
+    catch(...)
+    {
+        dlclose(m_hDLL);
+        throw runtime_error(string("Unknown exception while loading plugin '") + sFilename + string("'"));
+    }
+} 
+
+
+
+/*!\fn Plugin::Plugin(const Plugin &Other)
+ * \param Other is the other plugin instance to copy
+ */
+Plugin::Plugin(const Plugin &Other) 
+    :   m_hDLL(Other.m_hDLL),
+        m_pfnGetEngineVersion(Other.m_pfnGetEngineVersion),
+        m_pfnRegisterPlugin(Other.m_pfnRegisterPlugin),
+        m_pDLLRefCount(Other.m_pDLLRefCount),
+        m_sPluginFileName(Other.m_sPluginFileName)
+{
+    // Increase DLL reference counter
+    ++*m_pDLLRefCount;
+}
+
+
+
+/*!\fn Plugin::operator=(const Plugin &Other)
+ * \param Other is the other plugin instance to copy
+ * return copy of object
+ */
+Plugin& Plugin::operator=(const Plugin &Other)
+{
+    m_hDLL = Other.m_hDLL;
+    m_pfnGetEngineVersion = Other.m_pfnGetEngineVersion;
+    m_pfnRegisterPlugin = Other.m_pfnRegisterPlugin;
+    m_pDLLRefCount = Other.m_pDLLRefCount;
+    m_sPluginFileName = Other.m_sPluginFileName;
+    // Increase DLL reference counter
+    ++*m_pDLLRefCount;
+}
+
+
+
+Plugin::~Plugin() 
+{
+    // Only unload the DLL if there are no more references to it
+    if(!--*m_pDLLRefCount) 
+    {
+        delete m_pDLLRefCount;
+        dlclose(m_hDLL);
+    }
+}
+
+
+
+/*!\fn Plugin::registerPlugin(PluginManager &K)
+ * \param K is the pointer to plugin manager
+ */
+void Plugin::registerPlugin(PluginManager &K)
+{
+    m_pfnRegisterPlugin(K, m_sPluginFileName);
+}
diff -aurN zoneminder/trunk/src/zm_plugin.h zoneminder_new/trunk/src/zm_plugin.h
--- zoneminder/trunk/src/zm_plugin.h	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_plugin.h	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,78 @@
+#ifndef ZM_PLUGIN_H
+#define ZM_PLUGIN_H
+
+
+
+#include <stdlib.h>
+#include <stdio.h>
+#include <dlfcn.h>
+
+#include <stdexcept>
+#include "zm.h"
+
+
+
+using namespace std;
+
+
+
+class PluginManager;
+
+
+
+//! Signature for the version query function
+typedef int  fnGetEngineVersion();
+
+//! Signature for the plugin's registration function
+typedef void fnRegisterPlugin(PluginManager &, string);
+
+
+
+//! Representation of a plugin.
+/*! Use for loading plugin's shared library 
+ *  and registration of it to the PluginManager.
+ */
+class Plugin 
+{
+
+public:
+    
+    //! Initialize and load plugin
+    Plugin(const std::string &sFilename);
+    
+    //! Copy existing plugin instance
+    Plugin(const Plugin &Other);
+    
+    //! Operator =.
+    Plugin &operator =(const Plugin &Other);
+
+    //! Unload a plugin
+    ~Plugin();
+
+    //! Query the plugin for its expected engine version
+    int getEngineVersion() const { return m_pfnGetEngineVersion();}
+
+    //! Register the plugin to a PluginManager
+    void registerPlugin(PluginManager &K);
+        
+private:
+
+    //! Shared file name.
+    string m_sPluginFileName;
+    
+    //! DLL handle
+    void* m_hDLL; 
+    
+    //! Number of references to the DLL
+    size_t *m_pDLLRefCount;        
+
+    //! Version query function
+    fnGetEngineVersion *m_pfnGetEngineVersion; 
+
+    //! Plugin registration function
+    fnRegisterPlugin *m_pfnRegisterPlugin;
+};
+
+
+
+#endif //ZM_PLUGIN_H
diff -aurN zoneminder/trunk/src/zm_plugin_manager.cpp zoneminder_new/trunk/src/zm_plugin_manager.cpp
--- zoneminder/trunk/src/zm_plugin_manager.cpp	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_plugin_manager.cpp	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,118 @@
+#include "zm_plugin_manager.h"
+
+
+
+/*! \fn file_select(const struct direct *entry)
+ *  A functor for selection of files with specified extension.
+ *  \param entry is file structure
+ *  \return 1 if file match selection criteria and
+ *          0 otherwise.
+ *  NOTE: file extension is specified by PluginManager::m_sPluginExt
+ *  static variable.
+ */
+int file_select(const struct direct *entry)
+{
+    char *ptr;
+
+    if ((strcmp(entry->d_name, ".")== 0) || (strcmp(entry->d_name, "..") == 0))
+        return 0;
+
+    // Check for filename extensions.
+    ptr = rindex((char*)entry->d_name, '.');
+    if ((ptr != NULL) && (strcmp(ptr, (PluginManager::m_sPluginExt).c_str()) == 0))
+        return 1;
+    else
+        return 0;
+}
+
+
+
+
+/*! \fn join_paths(const string& p1, const string& p2)
+ *  \param p1 is the first part of desired path
+ *  \param p2 is the second part of desired path
+ *  \return joined path string.
+ */
+string join_paths(const string& p1, const string& p2)
+{
+    char sep = '/';
+    string tmp = p1;
+
+#ifdef _WIN32
+    sep = '\\';
+#endif
+
+    if (p1[p1.length()] != sep)
+    { // Need to add a path separator
+        tmp += sep;
+        return(tmp + p2);
+    }
+    else
+        return(p1 + p2);
+}
+
+
+
+string PluginManager::m_sPluginExt = DEFAULT_PLUGIN_EXT;
+
+
+PluginManager::PluginManager()
+{
+}
+
+
+
+/*!\fn PluginManager::loadPlugin(const string &sFilename))
+ * \param sFilename is the name of plugin file to load
+ */
+void PluginManager::loadPlugin(const string &sFilename)
+{
+    try
+    {
+        if(m_LoadedPlugins.find(sFilename) == m_LoadedPlugins.end())
+            m_LoadedPlugins.insert(PluginMap::value_type(sFilename, Plugin(sFilename))).first->second.registerPlugin(*this);
+    }
+    catch(runtime_error &ex)
+    {
+        Info("Runtime error: %s", ex.what());
+    }
+    catch(...)
+    {
+        Info("Unknown exception. Could not load %s.", sFilename.c_str());
+    }
+}
+
+
+
+/*!\fn PluginManager::findPlugins(const string &sPath)
+ * \param sPath is the path to folder to search plugins
+ * return count of found plugins
+ */
+int PluginManager::findPlugins(const string &sPath)
+{
+    
+    struct direct **files;
+
+    int count = scandir(sPath.c_str(), &files, file_select, alphasort);
+
+    for (int i = 1; i < count + 1; ++i)
+    {
+        string sFileName = files[i-1]->d_name;
+        string sFullPath = join_paths(sPath, sFileName);
+        
+        Info("Loading plugin %s ... ", sFullPath.c_str());
+        
+        loadPlugin(sFullPath);
+    }
+
+    return count;
+}
+
+
+/*!\fn PluginManager::configurePlugins(string sConfigFileName)
+ *  \param sConfigFileName is the path to the configuration file, where parameters for all plugins are given.
+ */
+void PluginManager::configurePlugins(string sConfigFileName)
+{
+    m_ImageAnalyser.configurePlugins(sConfigFileName);
+}
diff -aurN zoneminder/trunk/src/zm_plugin_manager.h zoneminder_new/trunk/src/zm_plugin_manager.h
--- zoneminder/trunk/src/zm_plugin_manager.h	1970-01-01 01:00:00.000000000 +0100
+++ zoneminder_new/trunk/src/zm_plugin_manager.h	2011-04-01 17:10:30.000000000 +0200
@@ -0,0 +1,85 @@
+#ifndef ZM_PLUGIN_MANAGER_H
+#define ZM_PLUGIN_MANAGER_H
+
+
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string>
+#include <map>
+#include <sys/types.h>
+#include <sys/dir.h>
+#include <sys/param.h>
+#include <unistd.h>
+
+#include "zm.h"
+#include "zm_image_analyser.h"
+#include "zm_detector.h"
+#include "zm_plugin.h"
+
+
+
+using namespace std;
+
+
+#define ZM_ENGINE_VERSION 24
+#define DEFAULT_PLUGIN_EXT ".zmpl"
+
+
+
+//! Map of plugins by their associated file names.
+typedef std::map<std::string, Plugin> PluginMap;
+
+
+//! External function for sorting of files in directory.
+extern int alphasort();
+
+
+//! Function to select files with plugins by extension.
+int file_select(const struct direct *entry);
+
+
+//! Join two path strings.
+string join_paths(const string& p1, const string& p2);
+
+
+
+//! Class for managing all loaded plugins.
+class PluginManager
+{
+
+public:
+
+    //! Default constructor.
+    PluginManager();
+    
+    //! Access the image analyser.
+    ImageAnalyser &getImageAnalyser() {return m_ImageAnalyser;}
+    
+    //! Loads a plugin.
+    void loadPlugin(const string &sFilename);
+
+    //! Find and load all plugins from given directory, returns number of found plugins.
+    int findPlugins(const string &sPath);
+
+    //! Configure all loaded plugins using given configuration file.
+    void configurePlugins(string sConfigFileName);
+
+    //! Set plugin extension.
+    void setPluginExt(string sPluginExt) { m_sPluginExt = sPluginExt; }
+
+    //! Extension for zm plugins.
+    static string m_sPluginExt;
+    
+private:
+    
+    //! All plugins currently loaded.
+    PluginMap m_LoadedPlugins;
+
+    //! The image analyser.
+    ImageAnalyser m_ImageAnalyser;
+};
+
+
+
+#endif //ZM_PLUGIN_MANAGER_H
diff -aurN zoneminder/trunk/src/zm_utils.h zoneminder_new/trunk/src/zm_utils.h
--- zoneminder/trunk/src/zm_utils.h	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_utils.h	2011-04-01 17:10:30.000000000 +0200
@@ -22,6 +22,7 @@
 
 #include <string>
 #include <vector>
+#include <stdio.h>
 
 typedef std::vector<std::string> StringVector;
 
diff -aurN zoneminder/trunk/src/zm_zone.cpp zoneminder_new/trunk/src/zm_zone.cpp
--- zoneminder/trunk/src/zm_zone.cpp	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_zone.cpp	2011-04-01 17:10:30.000000000 +0200
@@ -113,6 +113,48 @@
 	}
 }
 
+//=============================================================================
+bool Zone::CheckOverloadCount()
+{
+    Info("Overloaded count: %d, Overloaded frames: %d", overload_count, overload_frames);
+    if ( overload_count )
+    {
+            Info( "In overload mode, %d frames of %d remaining", overload_count, overload_frames );
+            Debug( 4, "In overload mode, %d frames of %d remaining", overload_count, overload_frames );
+            overload_count--;
+            return( false );
+    }
+    return true;
+}
+
+void Zone::SetScore(unsigned int nScore)
+{
+    score = nScore;
+}
+
+
+void Zone::SetAlarmImage(const Image* srcImage)
+{
+    delete image;
+    image = new Image(*srcImage);
+}
+
+int Zone::GetOverloadCount()
+{
+    return overload_count;
+}
+
+void Zone::SetOverloadCount(int nOverCount)
+{
+    overload_count = nOverCount;
+}
+
+int Zone::GetOverloadFrames()
+{
+    return overload_frames;
+}
+//===========================================================================
+
 bool Zone::CheckAlarms( const Image *delta_image )
 {
 	bool alarm = false;
diff -aurN zoneminder/trunk/src/zm_zone.h zoneminder_new/trunk/src/zm_zone.h
--- zoneminder/trunk/src/zm_zone.h	2011-04-01 17:08:30.000000000 +0200
+++ zoneminder_new/trunk/src/zm_zone.h	2011-04-01 17:10:30.000000000 +0200
@@ -147,6 +147,17 @@
 	static bool ParsePolygonString( const char *polygon_string, Polygon &polygon );
 	static bool ParseZoneString( const char *zone_string, int &zone_id, int &colour, Polygon &polygon );
 	static int Load( Monitor *monitor, Zone **&zones );
+
+    //=================================================
+    bool CheckOverloadCount();
+    int GetOverloadCount();
+    void SetOverloadCount(int nOverCount);
+    int GetOverloadFrames();
+    void SetScore(unsigned int nScore);
+    void SetAlarmImage(const Image* srcImage);
+
+	inline const Image *getPgImage() const { return( pg_image ); }
+	inline const Range *getRanges() const { return( ranges ); }
 };
 
 #endif // ZM_ZONE_H
diff -aurN zoneminder/trunk/web/lang/big5_big5.php zoneminder_new/trunk/web/lang/big5_big5.php
--- zoneminder/trunk/web/lang/big5_big5.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/big5_big5.php	2011-04-01 17:10:30.000000000 +0200
@@ -260,6 +260,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => '',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => '',
@@ -632,6 +633,7 @@
     'Update'               => 'Update',                 // Added - 2009-02-08
     'UpdateAvailable'      => 'An update to ZoneMinder is available.',
     'UpdateNotNecessary'   => 'No update is necessary.',
+    'UsedPlugins'	   => 'Used Plugins',
     'UseFilter'            => 'Use Filter',
     'UseFilterExprsPost'   => '&nbsp;filter&nbsp;expressions', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Use&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/cn_zh.php zoneminder_new/trunk/web/lang/cn_zh.php
--- zoneminder/trunk/web/lang/cn_zh.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/cn_zh.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'     => '',
     'DonateRemindWeek'      => '1',
     'DonateYes'             => '',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'              => '',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'              => 'Duration',
@@ -628,6 +629,7 @@
     'Update'                => '',
     'UpdateAvailable'       => 'ZoneMinder.',
     'UpdateNotNecessary'    => '',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'             => '',
     'UseFilterExprsPost'    => '&nbsp;&nbsp;', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'     => '&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/cs_cz.php zoneminder_new/trunk/web/lang/cs_cz.php
--- zoneminder/trunk/web/lang/cs_cz.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/cs_cz.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'Ne, nechci podpoit ZoneMinder, nepipomnat',
     'DonateRemindWeek'     => 'Nyn ne, pipomenout za tden',
     'DonateYes'            => 'Ano, chcit podpoit ZoneMinder nyn',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Sthnout',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Prbh',
@@ -628,6 +629,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'Je dostupn nov update ZoneMinder.',
     'UpdateNotNecessary'   => 'Update nen poteba.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Pout filtr',
     'UseFilterExprsPost'   => '&nbsp;vraz', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Pout&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/de_de.php zoneminder_new/trunk/web/lang/de_de.php
--- zoneminder/trunk/web/lang/de_de.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/de_de.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'Nein, ich m&ouml;chte nicht spenden, niemals erinnern.',
     'DonateRemindWeek'     => 'Noch nicht, erinnere mich in einer Woche noch mal.',
     'DonateYes'            => 'Ja, ich m&ouml;chte jetzt spenden.',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Dauer',
@@ -628,6 +629,7 @@
     'Update'               => 'Aktualisieren',
     'UpdateAvailable'      => 'Eine Aktualisierung f&uuml;r ZoneMinder ist verf&uuml;gbar.',
     'UpdateNotNecessary'   => 'Es ist keine Aktualisierung verf&uuml;gbar.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Benutze Filter',
     'UseFilterExprsPost'   => '&nbsp;Filter&nbsp;Ausdr&uuml;cke', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Benutze&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/dk_dk.php zoneminder_new/trunk/web/lang/dk_dk.php
--- zoneminder/trunk/web/lang/dk_dk.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/dk_dk.php	2011-04-01 17:10:30.000000000 +0200
@@ -257,6 +257,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Forlb',
@@ -629,6 +630,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'En updatering til ZoneMinder er tilstede.',
     'UpdateNotNecessary'   => 'Ingen updatering er ndvendig.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Brug Filter',
     'UseFilterExprsPost'   => '&nbsp;filter&nbsp;expressions', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Brug&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/en_gb.php zoneminder_new/trunk/web/lang/en_gb.php
--- zoneminder/trunk/web/lang/en_gb.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/en_gb.php	2011-04-01 17:10:30.000000000 +0200
@@ -257,6 +257,7 @@
     'DonateRemindNever'     => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'      => 'Not yet, remind again in 1 week',
     'DonateYes'             => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'              => 'Download',
     'DuplicateMonitorName'  => 'Duplicate Monitor Name',
     'Duration'              => 'Duration',
@@ -628,6 +629,7 @@
     'UpdateAvailable'       => 'An update to ZoneMinder is available.',
     'UpdateNotNecessary'    => 'No update is necessary.',
     'Update'                => 'Update',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilterExprsPost'    => '&nbsp;filter&nbsp;expressions', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'     => 'Use&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
     'UseFilter'             => 'Use Filter',
diff -aurN zoneminder/trunk/web/lang/es_ar.php zoneminder_new/trunk/web/lang/es_ar.php
--- zoneminder/trunk/web/lang/es_ar.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/es_ar.php	2011-04-01 17:10:30.000000000 +0200
@@ -207,6 +207,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Duracin',
@@ -579,6 +580,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'Una Actualizacin a ZoneMinder esta disponible',
     'UpdateNotNecessary'   => 'No se requiere Actualizacin',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Usar Filtro',
     'UseFilterExprsPost'   => '&nbsp;filtrar&nbsp;sentencias', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Utilizar&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/fr_fr.php zoneminder_new/trunk/web/lang/fr_fr.php
--- zoneminder/trunk/web/lang/fr_fr.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/fr_fr.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Dure',
@@ -628,6 +629,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'Mise  jour de ZM dispo.',
     'UpdateNotNecessary'   => 'Pas de mise  jour dispo.',
+    'UsedPlugins'	    => 'Utiliser des Plugins',
     'UseFilter'            => 'Util. Filtre',
     'UseFilterExprsPost'   => '&nbsp;filter&nbsp;expressions', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Util.&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/he_il.php zoneminder_new/trunk/web/lang/he_il.php
--- zoneminder/trunk/web/lang/he_il.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/he_il.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => ',    ,   ',
     'DonateRemindWeek'     => ' ,     ',
     'DonateYes'            => ',    ',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => '',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => ' ',
@@ -628,6 +629,7 @@
     'Update'               => '',
     'UpdateAvailable'      => ' - .',
     'UpdateNotNecessary'   => '  .',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => ' ',
     'UseFilterExprsPost'   => '&nbsp;filter&nbsp;expressions', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => '&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/hu_hu.php zoneminder_new/trunk/web/lang/hu_hu.php
--- zoneminder/trunk/web/lang/hu_hu.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/hu_hu.php	2011-04-01 17:10:30.000000000 +0200
@@ -265,6 +265,7 @@
     'DonateRemindNever'    => 'Nem akarom tmogatni, ne is emlkeztess',
     'DonateRemindWeek'     => 'Nem most, figyelmeztess 1 ht mlva',
     'DonateYes'            => 'Igen, most szeretnm tmogatni',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Letlt',
     'DuplicateMonitorName' => 'Monitor nevnek dupliklsa',
     'Duration'             => 'Idtartam',
@@ -637,6 +638,7 @@
     'Update'               => 'Frissts',
     'UpdateAvailable'      => 'Elrhet ZoneMinder frissts.',
     'UpdateNotNecessary'   => 'Nem szksges a frissts.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Szrt hasznl',
     'UseFilterExprsPost'   => '&nbsp;szr&nbsp;kifejezs hasznlata', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => '&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/it_it.php zoneminder_new/trunk/web/lang/it_it.php
--- zoneminder/trunk/web/lang/it_it.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/it_it.php	2011-04-01 17:10:30.000000000 +0200
@@ -261,6 +261,7 @@
     'DonateRemindNever'    => 'No, io non voglio donare, non lo faro\' mai',
     'DonateRemindWeek'     => 'Non ancora, ricordamelo ancora tra 1 settimana',
     'DonateYes'            => 'Si,mi piacerebbe donare qualcosa ora',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Il nome del monitor e\' gia\' presente', // Added - 2009-03-31
     'Duration'             => 'Durata',
@@ -633,6 +634,7 @@
     'Update'               => 'Aggiorna',
     'UpdateAvailable'      => 'Un aggiornamento di ZoneMinder &egrave; disponibilie.',
     'UpdateNotNecessary'   => 'Nessun aggiornamento necessario.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Usa Filtro',
     'UseFilterExprsPost'   => '&nbsp;espressioni&nbsp;filtri', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Usa&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/ja_jp.php zoneminder_new/trunk/web/lang/ja_jp.php
--- zoneminder/trunk/web/lang/ja_jp.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/ja_jp.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'p',
@@ -628,6 +629,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'ZoneMinder',
     'UpdateNotNecessary'   => 'Kv',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'gp',
     'UseFilterExprsPost'   => '&nbsp;', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'w:&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/nl_nl.php zoneminder_new/trunk/web/lang/nl_nl.php
--- zoneminder/trunk/web/lang/nl_nl.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/nl_nl.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Duur',
@@ -628,6 +629,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'een update voor ZoneMinder is beschikbaar',
     'UpdateNotNecessary'   => 'geen update noodzakelijk',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Gebruik Filter',
     'UseFilterExprsPost'   => '&nbsp;filter&nbsp;expressies', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Gebruik&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/pl_pl.php zoneminder_new/trunk/web/lang/pl_pl.php
--- zoneminder/trunk/web/lang/pl_pl.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/pl_pl.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Czas trwania',
@@ -628,6 +629,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'Jest dostpne uaktualnienie ZoneMinder ',
     'UpdateNotNecessary'   => 'Nie jest wymagane uaktualnienie',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Uyj filtru',
     'UseFilterExprsPost'   => '&nbsp;wyraenie&nbsp;filtru', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Uyj&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/pt_br.php zoneminder_new/trunk/web/lang/pt_br.php
--- zoneminder/trunk/web/lang/pt_br.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/pt_br.php	2011-04-01 17:10:30.000000000 +0200
@@ -196,6 +196,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Durao',
@@ -568,6 +569,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'Um update ao zoneminder est disponvel.',
     'UpdateNotNecessary'   => 'No  necessrio update.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Use Filtro',
     'UseFilterExprsPost'   => '&nbsp;expresses&nbsp;de&nbsp;filtragem', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Use&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/ro_ro.php zoneminder_new/trunk/web/lang/ro_ro.php
--- zoneminder/trunk/web/lang/ro_ro.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/ro_ro.php	2011-04-01 17:10:30.000000000 +0200
@@ -227,6 +227,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Durata',
@@ -599,6 +600,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => 'Sunt disponibile actualiz&#259;ri ZoneMinder.',
     'UpdateNotNecessary'   => 'Actulizarea nu este necesar&#259;.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Folose&#351;te filtru',
     'UseFilterExprsPost'   => '&nbsp;expresii&nbsp;de&nbsp;filtrare ', 
     'UseFilterExprsPre'    => 'Folose&#351;te&nbsp;', 
diff -aurN zoneminder/trunk/web/lang/ru_ru.php zoneminder_new/trunk/web/lang/ru_ru.php
--- zoneminder/trunk/web/lang/ru_ru.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/ru_ru.php	2011-04-01 17:10:30.000000000 +0200
@@ -256,6 +256,7 @@
     'DonateRemindNever'    => 'No, I don\'t want to donate, never remind',
     'DonateRemindWeek'     => 'Not yet, remind again in 1 week',
     'DonateYes'            => 'Yes, I\'d like to donate now',
+    'DoNativeMotionDetection'=> '   Motion Detection',
     'Download'             => 'Download',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => '',
@@ -628,6 +629,7 @@
     'Update'               => 'Update',
     'UpdateAvailable'      => '  ZoneMinder',
     'UpdateNotNecessary'   => '  ',
+    'UsedPlugins'	    => ' ',
     'UseFilter'            => ' ',
     'UseFilterExprsPost'   => '&nbsp;&nbsp;&nbsp;', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => '.&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/lang/se_se.php zoneminder_new/trunk/web/lang/se_se.php
--- zoneminder/trunk/web/lang/se_se.php	2011-04-01 17:08:32.000000000 +0200
+++ zoneminder_new/trunk/web/lang/se_se.php	2011-04-01 17:10:30.000000000 +0200
@@ -257,6 +257,7 @@
     'DonateRemindNever'    => 'Nej, Jag vill inte donera, pminn mig inte mer',
     'DonateRemindWeek'     => 'Inte n, pminn om 1 vecka',
     'DonateYes'            => 'Ja, jag vill grna donera nu',
+    'DoNativeMotionDetection'=> 'Do Native Motion Detection',
     'Download'             => 'Ladda ner',
     'DuplicateMonitorName' => 'Duplicate Monitor Name', // Added - 2009-03-31
     'Duration'             => 'Lngd',
@@ -629,6 +630,7 @@
     'Update'               => 'Uppdatera',
     'UpdateAvailable'      => 'En uppdatering till ZoneMinder finns tillgnglig.',
     'UpdateNotNecessary'   => 'Ingen uppdatering behvs.',
+    'UsedPlugins'	    => 'Used Plugins',
     'UseFilter'            => 'Anvnd filter',
     'UseFilterExprsPost'   => '&nbsp;filter&nbsp;expressions', // This is used at the end of the phrase 'use N filter expressions'
     'UseFilterExprsPre'    => 'Anvnd&nbsp;', // This is used at the beginning of the phrase 'use N filter expressions'
diff -aurN zoneminder/trunk/web/skins/classic/views/monitor.php zoneminder_new/trunk/web/skins/classic/views/monitor.php
--- zoneminder/trunk/web/skins/classic/views/monitor.php	2011-04-01 17:08:34.000000000 +0200
+++ zoneminder_new/trunk/web/skins/classic/views/monitor.php	2011-04-01 17:10:30.000000000 +0200
@@ -24,6 +24,8 @@
     return;
 }
 
+$newDoNativeMotDet = 0;
+
 $tabs = array();
 $tabs["general"] = $SLANG['General'];
 $tabs["source"] = $SLANG['Source'];
@@ -100,6 +102,8 @@
         'SignalCheckColour' => '#0100BE',
         'WebColour' => 'red',
         'Triggers' => "",
+	'DoNativeMotDet' => "yes",
+	'UsedPl' => "",
     );
 }
 
@@ -416,6 +420,8 @@
         <input type="hidden" name="newMonitor[Function]" value="<?= validHtmlStr($newMonitor['Function']) ?>"/>
         <input type="hidden" name="newMonitor[Enabled]" value="<?= validHtmlStr($newMonitor['Enabled']) ?>"/>
         <input type="hidden" name="newMonitor[RefBlendPerc]" value="<?= validHtmlStr($newMonitor['RefBlendPerc']) ?>"/>
+        <input type="hidden" name="newMonitor[DoNativeMotDet]" value="<?= validHtmlStr($newMonitor['DoNativeMotDet']) ?>"/>
+        <input type="hidden" name="newMonitor[UsedPlugins]" value="<?= validHtmlStr($newMonitor['UsedPlugins']) ?>"/>
         <input type="hidden" name="newMonitor[MaxFPS]" value="<?= validHtmlStr($newMonitor['MaxFPS']) ?>"/>
         <input type="hidden" name="newMonitor[AlarmMaxFPS]" value="<?= validHtmlStr($newMonitor['AlarmMaxFPS']) ?>"/>
 <?php
@@ -575,6 +581,8 @@
             <tr><td><?= $SLANG['AlarmMaximumFPS'] ?></td><td><input type="text" name="newMonitor[AlarmMaxFPS]" value="<?= validHtmlStr($newMonitor['AlarmMaxFPS']) ?>" size="6"/></td></tr>
             <tr><td><?= $SLANG['RefImageBlendPct'] ?></td><td><input type="text" name="newMonitor[RefBlendPerc]" value="<?= validHtmlStr($newMonitor['RefBlendPerc']) ?>" size="4"/></td></tr>
             <tr><td><?= $SLANG['Triggers'] ?></td><td>
+            <tr><td><?= $SLANG['UsedPlugins'] ?></td><td><input type="text" name="newMonitor[UsedPl]" value="<?= validHtmlStr($newMonitor['UsedPl']) ?>" size="50"/></td></tr>
+            <tr><td><?= $SLANG['DoNativeMotionDetection'] ?></td><td><input type="text" name="newMonitor[DoNativeMotDet]" value="<?= validHtmlStr($newMonitor['DoNativeMotDet']) ?>" size="5"/></td></tr>
 <?php
         $optTriggers = getSetValues( 'Monitors', 'Triggers' );
         $breakCount = (int)(ceil(count($optTriggers)));
